using EPiServer.BaseLibrary.Scheduling;
using EPiServer.Core;
using EPiServer.Logging.Compatibility;
using EPiServer.PlugIn;
using EPiServer.ServiceLocation;
using JonDJones.com.Core.Helpers;
using JonDJones.com.Core.Repositories;
using JonDJones.Com.Core;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;
using System.Web.Configuration;

namespace JonDJones.com.Core.ScheduledTasks
{
    [ScheduledPlugIn(DisplayName = "Content Page Importer",
        SortIndex = 100)]
    public class ContentPageImporter : JobBase
    {
        private static readonly ILog Logger = LogManager.GetLogger(MethodBase.GetCurrentMethod().DeclaringType);

        private int processedNodes;

        private int failedNodes;

        public ContentPageImporter()
        {
            processedNodes = 0;
            failedNodes = 0;
        }

        private long Duration { get; set; }

        public override string Execute()
        {
            var timer = Stopwatch.StartNew();

            var epiServerDependencies = ServiceLocator.Current.GetInstance<IEpiServerDependencies>();

            var fileDirectory = FileHelper.GetImportDirectoryPath();

            var jsonFiles = FileHelper.GetFiles(fileDirectory);

            if (jsonFiles.Any())
            {
                ProcessFiles(epiServerDependencies, jsonFiles);
            }
            else
                return "No files to process";

            timer.Stop();
            Duration = timer.ElapsedMilliseconds;

            return ToString();
        }

        private void ProcessFiles(IEpiServerDependencies epiServerDependencies, List<string> jsonFiles)
        {
            foreach (var jsonFile in jsonFiles)
            {
                using (var streamReader = new StreamReader(jsonFile))
                {
                    var json = streamReader.ReadToEnd();

                    ContentPageData contentPageData;

                    var settings = new JsonSerializerSettings
                    {
                        NullValueHandling = NullValueHandling.Ignore
                    };

                    try
                    {
                        contentPageData = JsonConvert.DeserializeObject<ContentPageData>(json, settings);
                    }
                    catch (JsonSerializationException ex)
                    {
                        Logger.Error(string.Format("Invalid Json file {0}", jsonFile), ex);
                        failedNodes = failedNodes + 1;
                        continue;
                    }
                    catch (JsonReaderException ex)
                    {
                        Logger.Error(string.Format("Invalid Json format within {0}", jsonFile), ex);
                        failedNodes = failedNodes + 1;
                        continue;
                    }

                    contentPageData.ParentContentReference = ContentReference.RootPage;

                    var contentPageRepository = new ContentPageRepository(epiServerDependencies);
                    var contentPageReference = contentPageRepository.CreateContentPage(contentPageData);

                    if (contentPageReference == null)
                    {
                        Logger.ErrorFormat("Unable to get create blog page {0} ", contentPageData.PageName);
                        failedNodes = failedNodes + 1;
                        continue;
                    }

                    processedNodes = processedNodes + 1;
                }
            }
        }

        public override string ToString()
        {
            return string.Format(
                "Imported {0} pages successfully in {1}ms on. {2} page(s) failed to import.",
                processedNodes,
                Duration,
                failedNodes);
        }
    }
}